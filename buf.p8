pico-8 cartridge // http://www.pico-8.com
version 35
__lua__
-- buf
-- by morganquirk

function _init()
    memset(0x8000, 0x66, 0x2000)
    update_shadows()
    --draw_mem_pixel(5,5,8)
end

function vec(x,y)
    local v = {
        x or 0,
        y or 0,
    }
    return v
end
function vdsq(v)
    return (v[1] * v[1] + v[2] * v[2])
end
function vnorm(v)
    local dist = sqrt(vdsq(v))
    return vec(v[1] / dist, v[2] / dist)
end


local ray = vnorm({1, 1})
local tf = 0
function _update()
    tf += 1
    ray = vnorm({sin(tf / 100), cos(tf / 100)})
    update_shadows()
end

function draw_mem_pixel(x,y,color)
    local addr = 0x8000 + y * 64 + x \ 2
    if x % 2 == 0 then
        poke(addr, color | (@addr & 0xf0))
    else
        poke(addr, (color << 4) | (@addr & 0x0f))
    end
end

function draw_shadow(mx,my,rx,ry,len)
    local x1 = mx * 8 + 0.5
    local y1 = my * 8 - 0.5
    for i = 1, len do
        x1 += rx
        y1 += ry
        local fx1 = flr(x1)
        local fy1 = flr(y1)
        for z = 1,8 do
            local addr = 0x8000 + (fy1 + z) * 64 + fx1 \ 2
            if fx1 % 2 == 1 then
                memset(addr + 1, 0x55, 3)
                draw_mem_pixel(fx1, fy1 + z, 5)
                draw_mem_pixel(fx1 + 7, fy1 + z, 5)
            else
                memset(addr, 0x55, 4)
            end
        end        
    end
    
end

function update_shadows()
    memset(0x8000, 0x66, 0x2000)
    local rx,ry = ray[1], ray[2]
    for x = 0, 15 do
        for y = 0, 15 do
            local tile = mget(x,y)
            if tile > 0 then
                draw_shadow(x,y,rx,ry,8)
            end
        end
    end
end

function _draw()
    cls()
    
    --[[for i = 0, 30 do
        for j = 0, 30 do
            draw_mem_pixel(i,j, (i + j) % 16)
        end
    end]]
    memcpy(0x6000, 0x8000, 0x2000) -- draw shadows
    map(0,0,0,0,15,15)
end

__gfx__
00000000cccccccccccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccccccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccccccccccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccc00ccccc00c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccc010ccc010c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccc011000110c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccc011111110c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000cccccc0111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000ccc0cc0111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000cc010c0111911191000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000cc010c0111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000ccc0100011111110c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000cccc01000000000cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000ccccc0111111110cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000ccccc0111111110cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000ccccc0100001010cc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc000000000000000000000000
00000000cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc000000000000000000000000
00000000cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc000000000000000000000000
00000000cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc000000000000000000000000
00000000cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc000000000000000000000000
00000000ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc44cc4cccccccccccccccccccc000000000000000000000000
00000000ccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc4e44eccccccccccc44cc4cccc000000000000000000000000
00000000ccccccccccccccccccccccc44cc4ccccccccccccccccccccccccccc4ccc4cccccccccc444444ccccccccccc4e44ecccc000000000000000000000000
00000000ccccccccccccccccccccccc4e44eccccccccccccccccccccccccccce4c4eccccccccccc44b4b4ccccccccc444444cccc000000000000000000000000
00000000cccccccccccccccccccccc444444cccccccccccccccccccccccccc4444444ccccccccc4444e4ccccccccccc44b4b4ccc000000000000000000000000
00000000cccccc2cccc4ccccccccccc44b4b4cccccccccccc44cc4ccccccccc4b4b4ccccccc4ccc2444ccccccccccc4444e4cccc000000000000000000000000
00000000ccc2cc4cc44b4e4ccccccc4444e4ccccccccccccc4e44ecccccc4c444e444cccccc4c444222cccccccc4ccc2444ccccc000000000000000000000000
00000000ccc4444424e444ccccc4ccc2444ccccccc4ccccc444444cccccc4cc24442ccccccc42444444cccccccc4c444222ccccc000000000000000000000000
00000000ccc44244244b44ccccc4c444222ccccccc4cc444244b4bcccccc4224222ccccccccc24244444ccccccc42444444ccccc000000000000000000000000
00000000cc24442424444e4cccc42444444ccccccc4244442444e4ccccccc244444ccccccccc42cc44c2cccccccc24244444cccc000000000000000000000000
00000000ccc44444c244222ccccc24244242ccccccc2424442444224ccccc244242cccccccc4c2ccc4cc2ccccccc42ccc422cccc000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66666666000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000004040400000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
